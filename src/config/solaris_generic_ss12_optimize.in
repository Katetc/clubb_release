# $Id$
# Makefile definitions for Sun Studio's Fortran compiler

# == Paths ==
# This is where the make command is going to put the resulting files
PREFIX = ..
BINDIR = $(PREFIX)/bin
LIBDIR = $(PREFIX)/lib

# == Compiler invocation ==
FC = f95 # Sun Fortran 8.2

# == Debugging ==
# It is sometimes helpful to turn on floating-point trapping for the 
#  standalone program, but this will not work when using the tuner.
# In Sun f95: remove the reference to ftrap, or use -ftrap=common
DEBUG = -g -C -fns=no -ftrap=%none #-stackvar -xcheck=init_local -ftrap=common

# == Machine specific flags ==
# The 2nd line is specific to ketley.math.uwm.edu.
# Note that when linking to sunperf (for LAPACK) you must use -dalign
ARCH = -xarch=native64 -xcache=native -xchip=native -dalign
#ARCH = -m64 -xarch=sse3a -xcache=native -xchip=opteron -dalign

# == Optimization ==
# Sun's f95 has great difficulty with statistics.F
# Either turn off optimization for that file or expect a long compilation. 
# Using -xtypemap it is possible to compile for quad precision floating 
# point on SPARC, but on AMD64/EMT64 this is still not implemented.
# These are all pretty conservative options, check the your compiler manual 
# for information on using more aggressive techniques (inlining, etc.)
# -KPIC is needed for shared libs
# Note that -g is needed for profiling.
# These options are good on a SPARC and AMD64 machine
#OPTIMIZE = -g -xO3 -xvector=lib -ftrap=%none
# This works on x86/x64 only
OPTIMIZE = -g -xO3 -xvector=simd -ftrap=%none
# These options are good for parallel tuning on ketley or OpenMP WRF-HOC.
#OPTIMIZE = -g -xopenmp -xparallel -stackvar -xipo=2 -xvector=simd -xO4 -ftrap=%none

# == Compiler flags (all) ==
# Preprocessing Directives:
#   -DNETCDF enables netCDF output
#   -DCOAMPS_MICRO enables COAMPS microphysics scheme
#   -DTUNER enables the tuning application
#   -Dradoffline and -Dnooverlap (see bugsrad documentation)
# You will need to `make clean' if you change these
# Use -M<include path> to set a module file directory
#FCFLAGS = $(DEBUG) $(ARCH)   -DTUNER -DCOAMPS_MICRO -Dnooverlap -Dradoffline -M$(NC_LOC)/include
FCFLAGS = $(OPTIMIZE) $(ARCH)   -DTUNER -DCOAMPS_MICRO -Dnooverlap -Dradoffline -M$(NC_LOC)/include
#FCFLAGS = $(OPTIMIZE) $(ARCH) -M$(NC_LOC)/include


# == NetCDF Location  ==
#NC_LOC = /usr/local/netcdf-sun32
NC_LOC = /usr/local/netcdf-sun64

# == LAPACK libraries ==
LAPACK = -xlic_lib=sunperf

# == Linking Flags ==
# Use -s to strip (no debugging); 
# -Bstatic; for static linking of libraries
# -xlibmopt; link the optimized version of libm (this can affect results)
LDFLAGS = -L$(LIBDIR) -R$(LIBDIR) -lhoc_param -lhoc_bugsrad -L$(NC_LOC)/lib -lnetcdf -xlibmopt $(LAPACK)

# == Static library processing ==
AR = ar
ARFLAGS = cru
RANLIB = ranlib

# == Shared library processing ==
SHARED = $(FC)
SHAREDFLAGS = -G
